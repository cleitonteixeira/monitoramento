import oracledb

# configuração user

username = "teknisa"
password = "teknisa"
dsn = "host:1521/teknisa"
def consulta(date):
    print("############")
    print (date)
    try:
        connection = oracledb.connect(user=username, password=password,
                                    host="192.168.0.91", port=1521, service_name="orclpdb")
        print("############")
        print(connection.version)

        cursor = connection.cursor()

        cursor.execute(f"""
               SELECT
to_char(l.DTCOMPCUSTO,'MM/YYYY') AS "PERIODO",l.CDFILIAL AS "CR",SUM(l.VRLANCCUST) AS "VALOR",
CASE
WHEN CDCONTCTBL IN
 (
    '42202001',
    '42202002',
    '42202003',
    '42202004',
    '42202005',
    '42202006',
    '42202007',
    '42202008',
    '42202009',
    '42202010',
    '42202011',
    '42202012',
    '42202013',
    '42202014',
    '42202015',
    '42202016',
    '42202017',
    '42202018',
    '42202019',
    '42202020',
    '42202021',
    '42202022',
    '42202023',
    '42202024',
    '42202025',
    '42202026',
    '42202027',
    '42202028',
    '42202029',
    '42202030',
    '42202031',
    '42202032',
    '42202033',
    '42202034',
    '42202035',
    '42202036',
    '42202037',
    '42202038',
    '42202039',
    '42202040',
    '42202041',
    '42202042',
    '42202043',
    '42202044',
    '42202045',
    '42202046',
    '42202047',
    '42202048',
    '42202049',
    '42202050',
    '42202051',
    '42202052',
    '42202053',
    '42202054',
    '42202055',
    '42202056',
    '42202057',
    '42202058',
    '42202059',
    '42202060',
    '42202061',
    '42202062',
    '42202063',
    '42202064',
    '42202065',
    '42202066',
    '42202067',
    '42202068',
    '42202069',
    '42202070',
    '42202071',
    '42202072',
    '42202073',
    '42202074',
    '42202075',
    '42202076',
    '42202077',
    '42202078',
    '42202079',
    '42202080',
    '42202081',
    '42202082',
    '42202083',
    '42202084',
    '42202085',
    '42202086',
    '42202087',
    '42202088',
    '42202089',
    '42202090',
    '42202091',
    '42202092',
    '42202093',
    '42202094',
    '42202095',
    '42202096',
    '42202097',
    '42202098',
    '42202099',
    '42202100',
    '42202101',
    '42202102',
    '42202103',
    '42202104',
    '41303008',
    '42102017',
    '41203018',
    '41103008',
    '41103009',
    '41103017',
    '41103020',
    '42202702',
    '42202800',
    '41203034',
    '42202703',
    '41203002',
    '42202705',
    '42102019',
    '41203017',
    '42202701',
    '41203020',
    '42102003',
    '42202704',
    '41203015',
    '41203037'
 ) THEN 'ADMINISTRATIVO'
 WHEN CDCONTCTBL IN 
 (
    '41201001',
    '41201002',
    '41201003',
    '41201004',
    '41201005',
    '41201006',
    '41201007',
    '41201008',
    '41201009',
    '41201010',
    '41201011',
    '41303007',
    '41201012',
    '41203007'
) THEN 'INSUMOS'
WHEN CDCONTCTBL IN 
 (
    '42201001',
    '42201002',
    '42201003',
    '42201004',
    '42201005',
    '42201006',
    '42201007',
    '42201008',
    '42201009',
    '42201010',
    '42201011',
    '42201012',
    '42201013',
    '42201014',
    '42201015',
    '42201016',
    '42201017',
    '42201018',
    '42201019',
    '42201020',
    '42201021',
    '42201022',
    '42201023',
    '42201024',
    '42201025',
    '42201026',
    '42201027',
    '42201028',
    '42201029',
    '42201030',
    '42201031',
    '42201032',
    '42201033',
    '42201034',
    '42201035',
    '42201036',
    '42201037',
    '42201038',
    '42101024',
    '42101007',
    '42201039',
    '41203031',
    '41203011'
) THEN 'PESSOAS'
WHEN CDCONTCTBL IN 
(
'42302001',
'42302004',
'42302005',
'42302006'
) THEN 'JUROS/DESPESAS'
WHEN CDCONTCTBL IN 
(
'42301001',
'42301002',
'42301007'
) THEN 'OUTRAS RECEITAS'
WHEN CDCONTCTBL = '31101001' THEN 'REVENDA DE PRODUTOS'
WHEN CDCONTCTBL LIKE '31102%' THEN 'VENDA DE PRODUTOS'
WHEN CDCONTCTBL LIKE '31103%' THEN 'VENDA DE SERVICOS'
WHEN CDCONTCTBL LIKE '31104%' THEN 'LOCACAO DE BENS'
WHEN CDCONTCTBL IN ('31105001','31105003','31105005') THEN 'PROVISAO RECEITAS'
WHEN CDCONTCTBL IN ('31105002','31105004','31105006') THEN 'REVERSAO PROVISAO RECEITAS'
WHEN CDCONTCTBL IN ('31201003','31201004','31201005','31201006') THEN 'IMPOSTOS'
WHEN CDCONTCTBL = '31201001' THEN 'VENDAS CANCELADAS'
WHEN CDCONTCTBL IN ('31201008','31201009','43101001','43101003') THEN 'TRIBUTOS'
WHEN CDCONTCTBL = '31201007' THEN 'PROVISAO IMPOSTOS'
ELSE 'OUTROS'
END AS "GRUPO"
FROM LANCCCUSTO l
WHERE
l.CDFILIAL NOT LIKE '9999' AND
CDCONTCTBL IN (SELECT DISTINCT(CDCONTCTBL) FROM LANCCCUSTO)
AND CDCONTCTBL NOT LIKE '1%' AND CDCONTCTBL NOT LIKE '2%' AND
to_char(l.DTCOMPCUSTO,'MM/YYYY') = '{date}' AND
l.CDCONTCTBL IN(
    '31103001',
    '31102001',
    '31101001',
    '31201001',
    '31201003','31201004','31201005','31201006',
    '42202001',
    '42202002',
    '42202003',
    '42202004',
    '42202005',
    '42202006',
    '42202007',
    '42202008',
    '42202009',
    '42202010',
    '42202011',
    '42202012',
    '42202013',
    '42202014',
    '42202015',
    '42202016',
    '42202017',
    '42202018',
    '42202019',
    '42202020',
    '42202021',
    '42202022',
    '42202023',
    '42202024',
    '42202025',
    '42202026',
    '42202027',
    '42202028',
    '42202029',
    '42202030',
    '42202031',
    '42202032',
    '42202033',
    '42202034',
    '42202035',
    '42202036',
    '42202037',
    '42202038',
    '42202039',
    '42202040',
    '42202041',
    '42202042',
    '42202043',
    '42202044',
    '42202045',
    '42202046',
    '42202047',
    '42202048',
    '42202049',
    '42202050',
    '42202051',
    '42202052',
    '42202053',
    '42202054',
    '42202055',
    '42202056',
    '42202057',
    '42202058',
    '42202059',
    '42202060',
    '42202061',
    '42202062',
    '42202063',
    '42202064',
    '42202065',
    '42202066',
    '42202067',
    '42202068',
    '42202069',
    '42202070',
    '42202071',
    '42202072',
    '42202073',
    '42202074',
    '42202075',
    '42202076',
    '42202077',
    '42202078',
    '42202079',
    '42202080',
    '42202081',
    '42202082',
    '42202083',
    '42202084',
    '42202085',
    '42202086',
    '42202087',
    '42202088',
    '42202089',
    '42202090',
    '42202091',
    '42202092',
    '42202093',
    '42202094',
    '42202095',
    '42202096',
    '42202097',
    '42202098',
    '42202099',
    '42202100',
    '42202101',
    '42202102',
    '42202103',
    '42202104',
    '41303008',
    '42102017',
    '41203018',
    '41103008',
    '41103009',
    '41103017',
    '41103020',
    '42202702',
    '42202800',
    '41203034',
    '42202703',
    '41203002',
    '42202705',
    '42102019',
    '41203017',
    '42202701',
    '41203020',
    '42102003',
    '42202704',
    '41203015',
    '41203037',
    '41201001',
    '41201002',
    '41201003',
    '41201004',
    '41201005',
    '41201006',
    '41201007',
    '41201008',
    '41201009',
    '41201010',
    '41201011',
    '41303007',
    '41201012',
    '41203007',
    '42201001',
    '42201002',
    '42201003',
    '42201004',
    '42201005',
    '42201006',
    '42201007',
    '42201008',
    '42201009',
    '42201010',
    '42201011',
    '42201012',
    '42201013',
    '42201014',
    '42201015',
    '42201016',
    '42201017',
    '42201018',
    '42201019',
    '42201020',
    '42201021',
    '42201022',
    '42201023',
    '42201024',
    '42201025',
    '42201026',
    '42201027',
    '42201028',
    '42201029',
    '42201030',
    '42201031',
    '42201032',
    '42201033',
    '42201034',
    '42201035',
    '42201036',
    '42201037',
    '42201038',
    '42101024',
    '42101007',
    '42201039',
    '41203031',
    '41203011'
)
GROUP BY to_char(l.DTCOMPCUSTO,'MM/YYYY'),l.CDFILIAL,
CASE
WHEN CDCONTCTBL IN
 (
    '42202001',
    '42202002',
    '42202003',
    '42202004',
    '42202005',
    '42202006',
    '42202007',
    '42202008',
    '42202009',
    '42202010',
    '42202011',
    '42202012',
    '42202013',
    '42202014',
    '42202015',
    '42202016',
    '42202017',
    '42202018',
    '42202019',
    '42202020',
    '42202021',
    '42202022',
    '42202023',
    '42202024',
    '42202025',
    '42202026',
    '42202027',
    '42202028',
    '42202029',
    '42202030',
    '42202031',
    '42202032',
    '42202033',
    '42202034',
    '42202035',
    '42202036',
    '42202037',
    '42202038',
    '42202039',
    '42202040',
    '42202041',
    '42202042',
    '42202043',
    '42202044',
    '42202045',
    '42202046',
    '42202047',
    '42202048',
    '42202049',
    '42202050',
    '42202051',
    '42202052',
    '42202053',
    '42202054',
    '42202055',
    '42202056',
    '42202057',
    '42202058',
    '42202059',
    '42202060',
    '42202061',
    '42202062',
    '42202063',
    '42202064',
    '42202065',
    '42202066',
    '42202067',
    '42202068',
    '42202069',
    '42202070',
    '42202071',
    '42202072',
    '42202073',
    '42202074',
    '42202075',
    '42202076',
    '42202077',
    '42202078',
    '42202079',
    '42202080',
    '42202081',
    '42202082',
    '42202083',
    '42202084',
    '42202085',
    '42202086',
    '42202087',
    '42202088',
    '42202089',
    '42202090',
    '42202091',
    '42202092',
    '42202093',
    '42202094',
    '42202095',
    '42202096',
    '42202097',
    '42202098',
    '42202099',
    '42202100',
    '42202101',
    '42202102',
    '42202103',
    '42202104',
    '41303008',
    '42102017',
    '41203018',
    '41103008',
    '41103009',
    '41103017',
    '41103020',
    '42202702',
    '42202800',
    '41203034',
    '42202703',
    '41203002',
    '42202705',
    '42102019',
    '41203017',
    '42202701',
    '41203020',
    '42102003',
    '42202704',
    '41203015',
    '41203037'
 ) THEN 'ADMINISTRATIVO'
 WHEN CDCONTCTBL IN 
 (
    '41201001',
    '41201002',
    '41201003',
    '41201004',
    '41201005',
    '41201006',
    '41201007',
    '41201008',
    '41201009',
    '41201010',
    '41201011',
    '41303007',
    '41201012',
    '41203007'
) THEN 'INSUMOS'
WHEN CDCONTCTBL IN 
 (
    '42201001',
    '42201002',
    '42201003',
    '42201004',
    '42201005',
    '42201006',
    '42201007',
    '42201008',
    '42201009',
    '42201010',
    '42201011',
    '42201012',
    '42201013',
    '42201014',
    '42201015',
    '42201016',
    '42201017',
    '42201018',
    '42201019',
    '42201020',
    '42201021',
    '42201022',
    '42201023',
    '42201024',
    '42201025',
    '42201026',
    '42201027',
    '42201028',
    '42201029',
    '42201030',
    '42201031',
    '42201032',
    '42201033',
    '42201034',
    '42201035',
    '42201036',
    '42201037',
    '42201038',
    '42101024',
    '42101007',
    '42201039',
    '41203031',
    '41203011'
) THEN 'PESSOAS'
WHEN CDCONTCTBL IN 
(
'42302001',
'42302004',
'42302005',
'42302006'
) THEN 'JUROS/DESPESAS'
WHEN CDCONTCTBL IN 
(
'42301001',
'42301002',
'42301007'
) THEN 'OUTRAS RECEITAS'
WHEN CDCONTCTBL = '31101001' THEN 'REVENDA DE PRODUTOS'
WHEN CDCONTCTBL LIKE '31102%' THEN 'VENDA DE PRODUTOS'
WHEN CDCONTCTBL LIKE '31103%' THEN 'VENDA DE SERVICOS'
WHEN CDCONTCTBL LIKE '31104%' THEN 'LOCACAO DE BENS'
WHEN CDCONTCTBL IN ('31105001','31105003','31105005') THEN 'PROVISAO RECEITAS'
WHEN CDCONTCTBL IN ('31105002','31105004','31105006') THEN 'REVERSAO PROVISAO RECEITAS'
WHEN CDCONTCTBL IN ('31201003','31201004','31201005','31201006') THEN 'IMPOSTOS'
WHEN CDCONTCTBL = '31201001' THEN 'VENDAS CANCELADAS'
WHEN CDCONTCTBL IN ('31201008','31201009','43101001','43101003') THEN 'TRIBUTOS'
WHEN CDCONTCTBL = '31201007' THEN 'PROVISAO IMPOSTOS'
ELSE 'OUTROS'
END
ORDER BY to_char(l.DTCOMPCUSTO,'MM/YYYY'),CDFILIAL        
        """)
        rows = cursor.fetchall()
        return rows
    except oracledb.DatabaseError as e:
        print (e)
    finally:
        if cursor:
            cursor.close()
        if connection:
            connection.close()
